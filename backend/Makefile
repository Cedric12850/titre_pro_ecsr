# -------------------------------
# Makefile pour Docker - site_titre_pro_ecsr
# -------------------------------

# Nom des services dans docker-compose
WEB_SERVICE = web
DB_SERVICE = db

# Commande compose
DC = docker compose -f ../docker-compose.yml

# -------------------------------
# Initialisation : build + up en arriÃ¨re-plan
# -------------------------------
init:
	@echo "ğŸš€ Build et lancement des containers en arriÃ¨re-plan..."
	$(DC) build
	$(DC) up -d

# -------------------------------
# Lancer le serveur Django (attachÃ© au terminal)
# -------------------------------
run:
	@echo "â–¶ï¸ DÃ©marrage du serveur Django..."
	$(DC) up

# -------------------------------
# AccÃ©der au shell Django
# -------------------------------
shell:
	@echo "ğŸ’» AccÃ¨s au shell Django..."
	$(DC) exec $(WEB_SERVICE) python manage.py shell

# -------------------------------
# Migrations
# -------------------------------
makemigrations:
	@echo "ğŸ“ CrÃ©ation des migrations..."
	$(DC) exec $(WEB_SERVICE) python manage.py makemigrations

migrate:
	@echo "âœ… Application des migrations..."
	$(DC) exec $(WEB_SERVICE) python manage.py migrate

# -------------------------------
# CrÃ©er un superuser
# -------------------------------
createsuperuser:
	@echo "ğŸ‘¤ CrÃ©ation d'un superuser Django..."
	$(DC) exec $(WEB_SERVICE) python manage.py createsuperuser

# -------------------------------
# Nettoyage des __pycache__ dans le container web
# -------------------------------
clean:
	@echo "ğŸ§¹ Nettoyage des __pycache__..."
	$(DC) exec $(WEB_SERVICE) find . -type d -name '__pycache__' -exec rm -rf {} +

# -------------------------------
# Stopper et supprimer tous les containers (mais conserve les volumes)
# -------------------------------
stop:
	@echo "ğŸ›‘ ArrÃªt des containers..."
	$(DC) down

# -------------------------------
# Stopper et supprimer containers + volumes
# -------------------------------
reset:
	@echo "ğŸ—‘ Suppression des containers et volumes..."
	$(DC) down -v

# -------------------------------
# Commande complÃ¨te setup : init + migrations + superuser
# -------------------------------
setup: init makemigrations migrate
	@echo "ğŸ’¡ Setup terminÃ©, vous pouvez crÃ©er un superuser avec : make createsuperuser"





# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Variables globales
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ifeq ($(OS),Windows_NT)
#     PYTHON = env/Scripts/python.exe
#     ACTIVATE = env\Scripts\activate
#     RM = rmdir /s /q
#     FIND = powershell -Command "Get-ChildItem -Recurse -Directory -Filter __pycache__ | Remove-Item -Recurse -Force"
# else
#     PYTHON = env/bin/python
#     ACTIVATE = source env/bin/activate
#     RM = rm -rf
#     FIND = find . -type d -name '__pycache__' -exec rm -r {} +
# endif

# PIP = $(PYTHON) -m pip

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Initialisation de l'environnement virtuel et installation des dÃ©pendances
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# init:
# ifeq ($(OS),Windows_NT)
# 	py -3.11 -m venv env
# else
# 	python3.11 -m venv env
# endif
# 	$(PIP) install --upgrade pip setuptools wheel
# 	$(PIP) install -r requirements.txt

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # VÃ©rifier que CKEditor est installÃ© (ou lâ€™installer)
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# check-ckeditor:
# 	$(PIP) show django-ckeditor || $(PIP) install django-ckeditor==6.3.1

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Lancer le serveur Django
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# run:
# 	$(PYTHON) manage.py runserver

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Migrations
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# migration:
# 	$(PYTHON) manage.py makemigrations

# migrate:
# 	$(PYTHON) manage.py migrate

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # CrÃ©er un super utilisateur
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# createsuperuser:
# 	$(PYTHON) manage.py createsuperuser

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Nettoyage des __pycache__
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# clean:
# 	$(FIND)

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Supprimer l'environnement virtuel
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# reset:
# 	$(RM) env

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # Installer toutes les dÃ©pendances et CKEditor d'un coup
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# setup: init check-ckeditor migrate

# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # CrÃ©er une nouvelle application Django (compatible Windows & Linux)
# # Utiliser : make app name=nom_app
# # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# app:
# ifeq ($(OS),Windows_NT)
# 	@if ("$(name)"=="") { \
# 		Write-Host "âŒ Erreur : vous devez spÃ©cifier un nom d'application. Exemple : make app name=conduite"; \
# 	} else { \
# 		Write-Host "ğŸ“ CrÃ©ation de l'application Django : $(name)"; \
# 		$(PYTHON) manage.py startapp $(name); \
# 		Write-Host "âœ… Application $(name) crÃ©Ã©e dans backend/$(name)"; \
# 	}
# else
# 	@if [ -z "$(name)" ]; then \
# 		echo "âŒ Erreur : vous devez spÃ©cifier un nom d'application. Exemple : make app name=conduite"; \
# 	else \
# 		echo "ğŸ“ CrÃ©ation de l'application Django : $(name)"; \
# 		$(PYTHON) manage.py startapp $(name); \
# 		echo "âœ… Application $(name) crÃ©Ã©e dans backend/$(name)"; \
# 	fi
# endif
