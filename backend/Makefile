# -------------------------------
# Makefile pour Docker - titre_pro_ecsr
# -------------------------------

# Nom des services dans docker-compose
WEB_SERVICE = web
DB_SERVICE = db

# Commande docker compose
DC = docker compose -f ../docker-compose.yml

# -------------------------------
# Initialisation : build + up en arriÃ¨re-plan
# -------------------------------
init:
	@echo "ğŸš€ Build et lancement des containers en arriÃ¨re-plan..."
	$(DC) build
	$(DC) up -d

# -------------------------------
# Lancer le serveur Django (attachÃ© au terminal)
# -------------------------------
run:
	@echo "â–¶ï¸ DÃ©marrage du serveur Django..."
	$(DC) up

# -------------------------------
# AccÃ©der au shell Django
# -------------------------------
shell:
	@echo "ğŸ’» AccÃ¨s au shell Django..."
	$(DC) exec $(WEB_SERVICE) python manage.py shell

# -------------------------------
# Migrations
# -------------------------------
makemigrations:
	@echo "ğŸ“ CrÃ©ation des migrations..."
	$(DC) exec $(WEB_SERVICE) python manage.py makemigrations

migrate:
	@echo "âœ… Application des migrations..."
	$(DC) exec $(WEB_SERVICE) python manage.py migrate

# -------------------------------
# CrÃ©er un superuser
# -------------------------------
createsuperuser:
	@echo "ğŸ‘¤ CrÃ©ation d'un superuser Django..."
	$(DC) exec $(WEB_SERVICE) python manage.py createsuperuser

# -------------------------------
# Nettoyage des __pycache__ dans le container web
# -------------------------------
clean:
	@echo "ğŸ§¹ Nettoyage des __pycache__..."
	$(DC) exec $(WEB_SERVICE) find . -type d -name '__pycache__' -exec rm -rf {} +

# -------------------------------
# Stopper et supprimer tous les containers (mais conserve les volumes)
# -------------------------------
stop:
	@echo "ğŸ›‘ ArrÃªt des containers..."
	$(DC) down

# -------------------------------
# Stopper et supprimer containers + volumes
# -------------------------------
reset:
	@echo "ğŸ—‘ Suppression des containers et volumes..."
	$(DC) down -v

# -------------------------------
# Commande complÃ¨te setup : init + migrations
# -------------------------------
setup: init makemigrations migrate
	@echo "ğŸ’¡ Setup terminÃ©, vous pouvez crÃ©er un superuser avec : make createsuperuser"

# -------------------------------
# CrÃ©er une nouvelle application Django
# Usage : make app name=nom_app
# -------------------------------
app:
ifeq ($(name),)
	$(error "âŒ Vous devez spÃ©cifier un nom d'application. Exemple : make app name=trame_pedagogique")
endif
	@echo "ğŸ“ CrÃ©ation de l'application Django : $(name)"
	$(DC) exec $(WEB_SERVICE) python manage.py startapp $(name)
	@echo "âœ… Application $(name) crÃ©Ã©e dans backend/$(name)"
