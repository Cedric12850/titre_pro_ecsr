{% extends "home/base.html" %}
{% load static %}
{% load dict_extras %}

{% block content %}
<h1 class="mb-4">Progression des objectifs pour {{ eleve.prenom }} {{ eleve.nom }}</h1>

<form method="post">
  {% csrf_token %}

  <!-- Onglets compétences -->
  <ul class="nav nav-tabs mb-3" id="competenceTabs" role="tablist">
    {% for comp_entry in competence_data %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if forloop.first %}active{% endif %} fw-semibold" 
                id="tab-{{ comp_entry.competence.numero }}" 
                data-bs-toggle="tab" 
                data-bs-target="#competence-{{ comp_entry.competence.numero }}" 
                type="button" role="tab" 
                aria-controls="competence-{{ comp_entry.competence.numero }}" 
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
          {{ comp_entry.competence.numero }} 
          <span class="badge 
                {% if comp_entry.statut == 'pas_aborde' %}bg-secondary
                {% elif comp_entry.statut == 'aborde' %}bg-info
                {% elif comp_entry.statut == 'en_cours' %}bg-warning text-dark
                {% elif comp_entry.statut == 'validee' %}bg-success
                {% else %}bg-secondary{% endif %} ms-2">
            {{ comp_entry.statut|capfirst }}
          </span>
        </button>
      </li>
    {% endfor %}
  </ul>

  <!-- Contenu onglets compétences -->
  <div class="tab-content" id="competenceTabsContent">
    {% for comp_entry in competence_data %}
      <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
           id="competence-{{ comp_entry.competence.numero }}" role="tabpanel" 
           aria-labelledby="tab-{{ comp_entry.competence.numero }}">

        <!-- Accordéon sous-compétences -->
        <div class="accordion" id="accordion-{{ comp_entry.competence.numero }}">
          {% for sc_entry in comp_entry.sous_competences %}
            <div class="accordion-item mb-2 border rounded">
              <h2 class="accordion-header" id="heading-{{ sc_entry.sous_competence.id }}">
                <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ sc_entry.sous_competence.id }}" 
                        aria-expanded="false" aria-controls="collapse-{{ sc_entry.sous_competence.id }}">
                  {{ sc_entry.sous_competence.lettre }} - {{ sc_entry.sous_competence.titre }}
                  <span class="badge 
                        {% if sc_entry.statut == 'pas_aborde' %}bg-secondary
                        {% elif sc_entry.statut == 'aborde' %}bg-info
                        {% elif sc_entry.statut == 'en_cours' %}bg-warning text-dark
                        {% elif sc_entry.statut == 'validee' %}bg-success
                        {% else %}bg-secondary{% endif %} ms-2">
                    {{ sc_entry.statut|capfirst }}
                  </span>
                </button>
              </h2>

              <div id="collapse-{{ sc_entry.sous_competence.id }}" class="accordion-collapse collapse"
                   aria-labelledby="heading-{{ sc_entry.sous_competence.id }}" data-bs-parent="#accordion-{{ comp_entry.competence.numero }}">
                <div class="accordion-body p-3">
                  <table class="table table-striped table-bordered mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Objectif</th>
                        <th class="text-center">Statut</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for obj in sc_entry.objectifs %}
                        <tr>
                          <td>{{ obj.objectif.intitule }}</td>
                          <td class="text-center">
                            <select name="form-{{ obj.id }}" class="form-select form-select-sm w-auto d-inline">
                              <option value="pas_aborde" {% if obj.statut == "pas_aborde" %}selected{% endif %}>Pas abordé</option>
                              <option value="aborde" {% if obj.statut == "aborde" %}selected{% endif %}>Abordé</option>
                              <option value="en_cours" {% if obj.statut == "en_cours" %}selected{% endif %}>En cours</option>
                              <option value="validee" {% if obj.statut == "validee" %}selected{% endif %}>Validée</option>
                            </select>
                            <span class="badge 
                                  {% if obj.statut == 'pas_aborde' %}bg-secondary
                                  {% elif obj.statut == 'aborde' %}bg-info
                                  {% elif obj.statut == 'en_cours' %}bg-warning text-dark
                                  {% elif obj.statut == 'validee' %}bg-success
                                  {% else %}bg-secondary{% endif %} ms-2">
                              {{ obj.get_statut_display }}
                            </span>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

      </div>
    {% endfor %}
  </div>

  <button type="submit" class="btn btn-primary mt-3">Mettre à jour les statuts</button>
</form>

<a href="{% url 'eleves:eleve-detail' eleve.id %}" class="btn btn-secondary mt-3">Retour</a>

{% endblock %}